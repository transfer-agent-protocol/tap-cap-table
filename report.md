# Aderyn Analysis Report

This report was generated by [Aderyn](https://github.com/Cyfrin/aderyn), a static analysis tool built by [Cyfrin](https://cyfrin.io), a blockchain security company. This report is not a substitute for manual audit or security review. It should not be relied upon for any purpose other than to assist in the identification of potential security vulnerabilities.
# Table of Contents

- [Summary](#summary)
  - [Files Summary](#files-summary)
  - [Files Details](#files-details)
  - [Issue Summary](#issue-summary)
- [High Issues](#high-issues)
  - [H-1: Reentrancy: State change after external call](#h-1-reentrancy-state-change-after-external-call)
- [Low Issues](#low-issues)
  - [L-1: Centralization Risk](#l-1-centralization-risk)
  - [L-2: Unspecific Solidity Pragma](#l-2-unspecific-solidity-pragma)
  - [L-3: PUSH0 Opcode](#l-3-push0-opcode)
  - [L-4: Inconsistent uint256/uint (or) int256/int types](#l-4-inconsistent-uint256uint-or-int256int-types)
  - [L-5: Unused Error](#l-5-unused-error)
  - [L-6: Loop Contains `require`/`revert`](#l-6-loop-contains-requirerevert)
  - [L-7: Storage Array Length not Cached](#l-7-storage-array-length-not-cached)
  - [L-8: Costly operations inside loop](#l-8-costly-operations-inside-loop)
  - [L-9: State Change Without Event](#l-9-state-change-without-event)
  - [L-10: State Variable Could Be Immutable](#l-10-state-variable-could-be-immutable)
  - [L-11: Unchecked Return](#l-11-unchecked-return)


# Summary

## Files Summary

| Key | Value |
| --- | --- |
| .sol Files | 4 |
| Total nSLOC | 521 |


## Files Details

| Filepath | nSLOC |
| --- | --- |
| src/CapTable.sol | 424 |
| src/CapTableFactory.sol | 32 |
| src/interfaces/ICapTable.sol | 58 |
| src/interfaces/ICapTableFactory.sol | 7 |
| **Total** | **521** |


## Issue Summary

| Category | No. of Issues |
| --- | --- |
| High | 1 |
| Low | 11 |


# High Issues

## H-1: Reentrancy: State change after external call

Changing state after an external call can lead to re-entrancy attacks.Use the checks-effects-interactions pattern to avoid this issue.

<details><summary>1 Found Instances</summary>


- Found in src/CapTableFactory.sol [Line: 33](chain/src/CapTableFactory.sol#L33)

	State is changed at: `capTableImplementation = newImplementation`
	```solidity
	        capTableBeacon.upgradeTo(newImplementation);
	```

</details>



# Low Issues

## L-1: Centralization Risk

Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details><summary>3 Found Instances</summary>


- Found in src/CapTableFactory.sol [Line: 10](chain/src/CapTableFactory.sol#L10)

	```solidity
	contract CapTableFactory is ICapTableFactory, Ownable {
	```

- Found in src/CapTableFactory.sol [Line: 21](chain/src/CapTableFactory.sol#L21)

	```solidity
	    function createCapTable(bytes16 id, string memory name, uint256 initial_shares_authorized) external onlyOwner returns (address) {
	```

- Found in src/CapTableFactory.sol [Line: 31](chain/src/CapTableFactory.sol#L31)

	```solidity
	    function updateCapTableImplementation(address newImplementation) external onlyOwner {
	```

</details>



## L-2: Unspecific Solidity Pragma

Consider using a specific version of Solidity in your contracts instead of a wide version. For example, instead of `pragma solidity ^0.8.0;`, use `pragma solidity 0.8.0;`

<details><summary>4 Found Instances</summary>


- Found in src/CapTable.sol [Line: 2](chain/src/CapTable.sol#L2)

	```solidity
	pragma solidity ^0.8.24;
	```

- Found in src/CapTableFactory.sol [Line: 2](chain/src/CapTableFactory.sol#L2)

	```solidity
	pragma solidity ^0.8.24;
	```

- Found in src/interfaces/ICapTable.sol [Line: 2](chain/src/interfaces/ICapTable.sol#L2)

	```solidity
	pragma solidity ^0.8.24;
	```

- Found in src/interfaces/ICapTableFactory.sol [Line: 2](chain/src/interfaces/ICapTableFactory.sol#L2)

	```solidity
	pragma solidity ^0.8.24;
	```

</details>



## L-3: PUSH0 Opcode

Solc compiler version 0.8.20 switches the default target EVM version to Shanghai, which means that the generated bytecode will include PUSH0 opcodes. Be sure to select the appropriate EVM version in case you intend to deploy on a chain other than mainnet like L2 chains that may not support PUSH0, otherwise deployment of your contracts will fail.

<details><summary>4 Found Instances</summary>


- Found in src/CapTable.sol [Line: 2](chain/src/CapTable.sol#L2)

	```solidity
	pragma solidity ^0.8.24;
	```

- Found in src/CapTableFactory.sol [Line: 2](chain/src/CapTableFactory.sol#L2)

	```solidity
	pragma solidity ^0.8.24;
	```

- Found in src/interfaces/ICapTable.sol [Line: 2](chain/src/interfaces/ICapTable.sol#L2)

	```solidity
	pragma solidity ^0.8.24;
	```

- Found in src/interfaces/ICapTableFactory.sol [Line: 2](chain/src/interfaces/ICapTableFactory.sol#L2)

	```solidity
	pragma solidity ^0.8.24;
	```

</details>



## L-4: Inconsistent uint256/uint (or) int256/int types

Inconsistency in declaring uint256/uint (or) int256/int variables within a contract. Use explicit size declarations (uint256 or int256). Consider keeping the naming convention consistent in a given contract. Explicit size declarations are preferred (uint256, int256) over implicit ones (uint, int) to avoid confusion.

<details><summary>11 Found Instances</summary>


- Found in src/CapTable.sol [Line: 443](chain/src/CapTable.sol#L443)

	```solidity
	    function getActivePosition(bytes16 stakeholderId, bytes16 securityId) external view returns (bytes16, uint, uint, uint40) {
	```

- Found in src/CapTable.sol [Line: 449](chain/src/CapTable.sol#L449)

	```solidity
	    function getAveragePosition(bytes16 stakeholderId, bytes16 stockClassId) external view returns (uint, uint, uint40) {
	```

- Found in src/CapTable.sol [Line: 451](chain/src/CapTable.sol#L451)

	```solidity
	        uint quantityPrice = 0;
	```

- Found in src/CapTable.sol [Line: 452](chain/src/CapTable.sol#L452)

	```solidity
	        uint quantity = 0;
	```

- Found in src/CapTable.sol [Line: 454](chain/src/CapTable.sol#L454)

	```solidity
	        for (uint i = 0; i < activeSecurityIDs.length; i++) {
	```

- Found in src/interfaces/ICapTable.sol [Line: 77](chain/src/interfaces/ICapTable.sol#L77)

	```solidity
	    function getActivePosition(bytes16 stakeholderId, bytes16 securityId) external view returns (bytes16, uint, uint, uint40);
	```

- Found in src/interfaces/ICapTable.sol [Line: 81](chain/src/interfaces/ICapTable.sol#L81)

	```solidity
	    function getAveragePosition(bytes16 stakeholderId, bytes16 stockClassId) external view returns (uint, uint, uint40);
	```

</details>



## L-5: Unused Error

Consider using or removing the unused error.

<details><summary>3 Found Instances</summary>


- Found in src/CapTable.sol [Line: 44](chain/src/CapTable.sol#L44)

	```solidity
	    error StockClassDoesNotExist(bytes16 stock_class_id);
	```

- Found in src/CapTable.sol [Line: 48](chain/src/CapTable.sol#L48)

	```solidity
	    error InsufficientIssuerSharesAuthorized();
	```

- Found in src/CapTable.sol [Line: 49](chain/src/CapTable.sol#L49)

	```solidity
	    error InsufficientStockClassSharesAuthorized();
	```

</details>



## L-6: Loop Contains `require`/`revert`

Avoid `require` / `revert` statements in a loop because a single bad item can cause the whole transaction to fail. It's better to forgive on fail and return failed elements post processing of the loop

<details><summary>2 Found Instances</summary>


- Found in src/CapTable.sol [Line: 101](chain/src/CapTable.sol#L101)

	```solidity
	        for (uint256 i = 0; i < params.stockClassesInitialShares.length; i++) {
	```

- Found in src/CapTable.sol [Line: 129](chain/src/CapTable.sol#L129)

	```solidity
	        for (uint256 i = 0; i < stakeholderIds.length; i++) {
	```

</details>



## L-7: Storage Array Length not Cached

Calling `.length` on a storage array in a loop condition is expensive. Consider caching the length in a local variable in memory before the loop and reusing it.

<details><summary>2 Found Instances</summary>


- Found in src/CapTable.sol [Line: 81](chain/src/CapTable.sol#L81)

	```solidity
	        for (uint256 i = 0; i < stakeholders.length; i++) {
	```

- Found in src/CapTable.sol [Line: 82](chain/src/CapTable.sol#L82)

	```solidity
	            for (uint256 j = 0; j < stockClasses.length; j++) {
	```

</details>



## L-8: Costly operations inside loop

Invoking `SSTORE` operations in loops may waste gas. Use a local variable to hold the loop computation result.

<details><summary>2 Found Instances</summary>


- Found in src/CapTable.sol [Line: 101](chain/src/CapTable.sol#L101)

	```solidity
	        for (uint256 i = 0; i < params.stockClassesInitialShares.length; i++) {
	```

- Found in src/CapTable.sol [Line: 129](chain/src/CapTable.sol#L129)

	```solidity
	        for (uint256 i = 0; i < stakeholderIds.length; i++) {
	```

</details>



## L-9: State Change Without Event

There are state variable changes in this function but no event is emitted. Consider emitting an event to enable offchain indexers to track the changes.

<details><summary>15 Found Instances</summary>


- Found in src/CapTable.sol [Line: 90](chain/src/CapTable.sol#L90)

	```solidity
	    function seedSharesAuthorizedAndIssued(InitialShares calldata params) external override {
	```

- Found in src/CapTable.sol [Line: 112](chain/src/CapTable.sol#L112)

	```solidity
	    function seedMultipleActivePositionsAndSecurityIds(
	```

- Found in src/CapTable.sol [Line: 179](chain/src/CapTable.sol#L179)

	```solidity
	    function createStockLegendTemplate(bytes16 _id) external override onlyAdmin {
	```

- Found in src/CapTable.sol [Line: 186](chain/src/CapTable.sol#L186)

	```solidity
	    function addWalletToStakeholder(bytes16 _stakeholder_id, address _wallet) external override onlyOperator {
	```

- Found in src/CapTable.sol [Line: 196](chain/src/CapTable.sol#L196)

	```solidity
	    function removeWalletFromStakeholder(bytes16 _stakeholder_id, address _wallet) external override onlyOperator {
	```

- Found in src/CapTable.sol [Line: 204](chain/src/CapTable.sol#L204)

	```solidity
	    function issueStock(StockIssuanceParams calldata params) external override onlyOperator {
	```

- Found in src/CapTable.sol [Line: 219](chain/src/CapTable.sol#L219)

	```solidity
	    function repurchaseStock(StockParams calldata params, uint256 quantity, uint256 price) external override onlyOperator {
	```

- Found in src/CapTable.sol [Line: 247](chain/src/CapTable.sol#L247)

	```solidity
	    function retractStockIssuance(StockParams calldata params) external override onlyOperator {
	```

- Found in src/CapTable.sol [Line: 265](chain/src/CapTable.sol#L265)

	```solidity
	    function reissueStock(StockParams calldata params, bytes16[] memory resulting_security_ids) external override onlyOperator {
	```

- Found in src/CapTable.sol [Line: 285](chain/src/CapTable.sol#L285)

	```solidity
	    function cancelStock(StockParams calldata params, uint256 quantity) external override onlyOperator {
	```

- Found in src/CapTable.sol [Line: 312](chain/src/CapTable.sol#L312)

	```solidity
	    function transferStock(StockTransferParams calldata params) external override onlyOperator {
	```

- Found in src/CapTable.sol [Line: 342](chain/src/CapTable.sol#L342)

	```solidity
	    function acceptStock(bytes16 stakeholderId, bytes16 stockClassId, bytes16 securityId, string[] memory comments) external override onlyOperator {
	```

- Found in src/CapTable.sol [Line: 356](chain/src/CapTable.sol#L356)

	```solidity
	    function adjustIssuerAuthorizedShares(
	```

- Found in src/CapTable.sol [Line: 378](chain/src/CapTable.sol#L378)

	```solidity
	    function adjustStockClassAuthorizedShares(
	```

- Found in src/CapTableFactory.sol [Line: 31](chain/src/CapTableFactory.sol#L31)

	```solidity
	    function updateCapTableImplementation(address newImplementation) external onlyOwner {
	```

</details>



## L-10: State Variable Could Be Immutable

State variables that are only changed in the constructor should be declared immutable to save gas. Add the `immutable` attribute to state variables that are only changed in the constructor

<details><summary>1 Found Instances</summary>


- Found in src/CapTableFactory.sol [Line: 12](chain/src/CapTableFactory.sol#L12)

	```solidity
	    UpgradeableBeacon public capTableBeacon;
	```

</details>



## L-11: Unchecked Return

Function returns a value but it is ignored. Consider checking the return value.

<details><summary>5 Found Instances</summary>


- Found in src/CapTable.sol [Line: 60](chain/src/CapTable.sol#L60)

	```solidity
	        _grantRole(ADMIN_ROLE, admin);
	```

- Found in src/CapTable.sol [Line: 492](chain/src/CapTable.sol#L492)

	```solidity
	        _grantRole(ADMIN_ROLE, addr);
	```

- Found in src/CapTable.sol [Line: 497](chain/src/CapTable.sol#L497)

	```solidity
	        _revokeRole(ADMIN_ROLE, addr);
	```

- Found in src/CapTable.sol [Line: 502](chain/src/CapTable.sol#L502)

	```solidity
	        _grantRole(OPERATOR_ROLE, addr);
	```

- Found in src/CapTable.sol [Line: 507](chain/src/CapTable.sol#L507)

	```solidity
	        _revokeRole(OPERATOR_ROLE, addr);
	```

</details>



