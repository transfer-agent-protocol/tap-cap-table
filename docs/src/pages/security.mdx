# Security Toolchain

[![Security Scans](https://github.com/transfer-agent-protocol/tap-cap-table/actions/workflows/security.yml/badge.svg)](https://github.com/transfer-agent-protocol/tap-cap-table/actions/workflows/security.yml)

Layered approach. See [WARP.md](https://github.com/transfer-agent-protocol/tap-cap-table/blob/main/WARP.md#static-analysis--security) for full details.

**Verify locally:** `make security && make test-invariant` — should pass with 0 high findings.

## Current Status

| Tool | High | Medium | Low | Status |
|------|------|--------|-----|--------|
| Aderyn | 0 | 0 | 5 | ✅ All acceptable |
| Slither | 0 | 0 | 3 | ✅ All acceptable |
| Invariant Tests | - | - | - | ✅ 7 passing |
| Unit Tests | - | - | - | ✅ 45 passing |

## Tools

### Aderyn
Real-time static linting. Fast feedback while coding.
- Reports: [`report.md`](https://github.com/transfer-agent-protocol/tap-cap-table/blob/main/report.md)

### Slither
Deeper static analysis (taint tracking, control-flow).
- Reports: [`chain/slither-report.md`](https://github.com/transfer-agent-protocol/tap-cap-table/blob/main/chain/slither-report.md)
- CI: Fails on high severity, uploads SARIF to GitHub Security tab

### Foundry Invariant Tests
Stateful fuzzing for core accounting rules.
- Tests: [`chain/test/invariants/`](https://github.com/transfer-agent-protocol/tap-cap-table/tree/main/chain/test/invariants)
- Config: 256 runs / 50 depth baseline

**Invariants tested:**
- `shares_issued <= shares_authorized` (issuer and stock classes)
- Stakeholder/stock class index mapping consistency
- Count consistency between contract and tracked state
- Stock class authorized never exceeds issuer authorized

### Unit Tests

| File | Type | Purpose |
|------|------|---------|
| `CapTable.t.sol` | Base | Test helpers/fixtures |
| `StockIssuance.t.sol` | Unit | Issuance logic, error cases |
| `StockTransfer.t.sol` | Unit | Transfer mechanics, edge cases |
| `StockCancellation.t.sol` | Unit | Cancel/partial cancel flows |
| `StockRepurchase.t.sol` | Unit | Repurchase flows |
| `StockReissuance.t.sol` | Unit | Reissuance mechanics |
| `StockRetraction.t.sol` | Unit | Retraction flow |
| `StockAcceptance.t.sol` | Unit | Acceptance flow |
| `Adjustment.t.sol` | Unit | Share adjustment constraints |
| `AccessControl.t.sol` | Unit | Role-based access |
| `Issuer.t.sol` | Unit | Issuer initialization |
| `Stakeholder.t.sol` | Unit | CRUD + duplicates |
| `StockClass.t.sol` | Unit | CRUD + duplicates |
| `Wallet.t.sol` | Unit | Wallet mapping |
| `Minting.t.sol` | Unit | Batch minting |
| `CapTableFactory.sol` | Unit | Factory + upgrades |

**Why both unit + invariant tests?**
- **Unit**: Specific function behavior, revert messages, single flows, edge cases
- **Invariant**: Properties hold after random sequences of calls (emergent bugs)

## Commands

| Command | Description |
|---------|-------------|
| `make test` | Run all unit tests (45 tests) |
| `make test-invariant` | Short invariant fuzz (256 runs, 50 depth) |
| `make test-invariant-deep` | Deep invariant fuzz (2000 runs, 100 depth) |
| `make aderyn` | Run Aderyn → `report.md` |
| `make slither` | Run Slither → `chain/slither-report.md` |
| `make security` | Run aderyn + slither |

## Philosophy

- Catch obvious stuff early (Aderyn)
- Dig deeper statically (Slither)
- Stress-test logic over sequences (Invariants)
- Verify specific behaviors & errors (Unit tests)
- Pre-audit cleanup → reduces noise for auditors
- No single tool replaces a full audit
